<?php
// $Id: eml_config.module, v 2.0 2010-11-22 ashipunova $
/*
 * Form for eml settings, required by views_bonus_eml_export
 * ?q=eml_config
*/

require_once("csv2drupal.inc");

function csv2drupal_menu() {

  $items = array();
  $items['csv2drupal'] = array (
    'title' => t('Export CSV files into predefined custom content types for the LTER project'),
    'page callback' => 'csv2drupal_page',
    'access arguments' => array('administer nodes'),
    'type' => MENU_SUGGESTED_ITEM,
//    'file' => 'csv2drupal_form.inc',
    );
  return $items;
}

function csv2drupal_page() {
  return drupal_get_form('eml_config_form');
}

function eml_config_form($form_state) {
  $form['#attributes']['enctype'] = 'multipart/form-data';

  $form['upload'] = array(
   '#type'  => 'file',
   '#title' => t('Upload Excel file'),
   '#size'  => 40,
  );

  $form['dir_name'] = array(
    '#type' => 'textfield',
    '#title' => t('Path to directory'),
//      home
//    '#default_value' => '/Users/ashipunova/work/drupal/lter/new/today/csv_examples_hor',
    '#default_value' => '/Users/anna/work/drupal/lter/git_LTER_csv2drupal/files',
    '#size' => 60,
    '#maxlength' => 128,
//    '#required' => TRUE,
  );

  $form['submit'] = array (
  '#type' => 'submit',
  '#value' => t('Upload'),
  );

  return $form;
}

function eml_config_form_submit($form, $form_state) {
//  dpm($form_state['values']['dir_name']);
  $dir_name = $form_state['values']['dir_name'];
  if (!empty($dir_name)) {
    drupal_set_message('$dir_name = ' . $dir_name);
    $files = file_scan_directory($dir_name, '\.xls');
    foreach ($files as $file ) {
      $filepath = $file->filename;
      dpr($filepath);
      $content = get_data_from_excel_file($filepath);
      create_nodes($content);

      /* failing that: */
      // drupal_set_message(print_r($file,1)); // show the file object
    }

  }
  else {
  $file = file_save_upload('upload');
    if ($file) {
      $dest_path = file_directory_path() . '/upload';
  //    $result = file_copy($file, $dest_path, FILE_EXISTS_RENAME);
      $result = file_copy($file, $dest_path, FILE_EXISTS_REPLACE);

      if ($result) {
        $filepath = $file->filepath;
//        dpr($filepath);
//        sites/default/files/upload/1982_2000gs81tusbm_2_CSVb.xls
//        dpm($filepath);
        $content = get_data_from_excel_file($filepath);
        create_nodes($content);
  //      dpr($content);
      }
    }
    else {
      form_set_error('eml_config_form', t("Failed to save the file."));
    }
  }
}
